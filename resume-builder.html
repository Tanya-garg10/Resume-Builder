<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ================= AUTH CHECK ================= */
    const currentUser = localStorage.getItem('currentUser');
    if (!currentUser) {
        window.location.href = './login.html';
        return;
    }

    /* ================= ELEMENTS ================= */
    const form = document.getElementById('resume-form');
    const skillsList = document.getElementById('skills-list');
    const addSkillBtn = document.getElementById('add-skill');
    const skillInput = document.getElementById('skill-input');
    const downloadPdfBtn = document.getElementById('download-pdf');
    const downloadPreviewPdfBtn = document.getElementById('download-preview-pdf');
    const previewContainer = document.getElementById('resume-preview');

    const authControls = document.getElementById('auth-controls');
    const profileDropdown = document.getElementById('profile-dropdown');
    const showAuthBtn = document.getElementById('show-auth');
    const logoutDropdown = document.getElementById('logout-dropdown');
    const dropdownUserName = document.getElementById('dropdown-user-name');

    let skills = [];

    /* ================= INIT ================= */
    loadUserDataInternal();
    updateAuthUI();
    renderSkills();
    updatePreview();
    loadSectionOrder();
    initSectionDragAndDrop();

    /* ================= FORM INPUT ================= */
    if (form) {
        form.addEventListener('input', function (e) {

            const id = e.target.id;
            const value = e.target.value.trim();

            if (id === 'email' && value && !Validator.isValidEmail(value)) {
                ValidationUI.showError('email', 'Invalid email');
            } else ValidationUI.clearError('email');

            if (id === 'phone' && value && !Validator.isValidPhone(value)) {
                ValidationUI.showError('phone', 'Invalid phone');
            } else ValidationUI.clearError('phone');

            if (id === 'linkedin' && value && !Validator.isValidLinkedIn(value)) {
                ValidationUI.showError('linkedin', 'Invalid LinkedIn URL');
            } else ValidationUI.clearError('linkedin');

            if (id === 'github' && value && !Validator.isValidGitHub(value)) {
                ValidationUI.showError('github', 'Invalid GitHub URL');
            } else ValidationUI.clearError('github');

            updatePreview();
            saveResumeData();
        });
    }

    /* ================= SKILLS ================= */
    addSkillBtn?.addEventListener('click', () => {
        const skill = skillInput.value.trim();
        if (skill && !skills.includes(skill)) {
            skills.push(skill);
            skillInput.value = '';
            renderSkills();
            updatePreview();
            saveResumeData();
        }
    });

    skillsList?.addEventListener('click', e => {
        if (e.target.classList.contains('skill-tag')) {
            skills = skills.filter(s => s !== e.target.textContent);
            renderSkills();
            updatePreview();
            saveResumeData();
        }
    });

    function renderSkills() {
        skillsList.innerHTML = skills.map(s => `<span class="skill-tag">${s}</span>`).join('');
    }

    /* ================= PREVIEW ================= */
    function updatePreview() {
        const g = id => document.getElementById(id)?.value || '';
        const t = (id, v, f='') => document.getElementById(id).textContent = v || f;

        t('preview-name', g('name'), 'Your Name');
        t('preview-email', g('email'));
        t('preview-phone', g('phone'));
        t('preview-location', g('location'));
        t('preview-linkedin', g('linkedin'));
        t('preview-github', g('github'));
        t('preview-summary', g('summary'));

        t('preview-education',
            `${g('degree')}${g('institution') ? ' from ' + g('institution') : ''}${g('year') ? ', ' + g('year') : ''}${g('cgpa') ? ' (CGPA: ' + g('cgpa') + ')' : ''}`
        );

        document.getElementById('preview-skills').innerHTML =
            skills.map(s => `<span>${s}</span>`).join('');

        document.getElementById('preview-experience').innerHTML =
            `<strong>${g('exp-title')}</strong>${g('exp-org') ? ' at ' + g('exp-org') : ''}<br>${g('exp-duration')}<br>${g('exp-desc')}`;

        t('preview-achievements', g('achievements'));
    }

    /* ================= STORAGE ================= */
    function saveResumeData() {
        const userData = getUserData(currentUser) || {};
        userData.resume = {
            name: g('name'), email: g('email'), phone: g('phone'),
            location: g('location'), linkedin: g('linkedin'), github: g('github'),
            summary: g('summary'), degree: g('degree'), institution: g('institution'),
            year: g('year'), cgpa: g('cgpa'), skills,
            expTitle: g('exp-title'), expOrg: g('exp-org'),
            expDuration: g('exp-duration'), expDesc: g('exp-desc'),
            achievements: g('achievements')
        };
        saveUserData(currentUser, userData);
    }

    /* ================= PDF ================= */
    function exportPDF() {
        if (!g('name')) {
            ValidationUI.showToast('Enter name first', 'error');
            return;
        }
        html2pdf().set({
            margin: 0.5,
            filename: `${g('name').replace(/\s+/g,'_')}_Resume.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        }).from(previewContainer).save();
    }

    downloadPdfBtn?.addEventListener('click', exportPDF);
    downloadPreviewPdfBtn?.addEventListener('click', exportPDF);

    /* ================= AUTH UI ================= */
    function updateAuthUI() {
        if (currentUser) {
            authControls.classList.add('hidden');
            profileDropdown.classList.remove('hidden');
            const user = getUserData(currentUser);
            dropdownUserName.textContent = user?.profile?.fullname || currentUser;
        }
    }

    logoutDropdown?.addEventListener('click', e => {
        e.preventDefault();
        localStorage.removeItem('currentUser');
        window.location.href = './index.html';
    });

    /* ================= DRAG & DROP ================= */
    let dragged = null;

    function initSectionDragAndDrop() {
        previewContainer.querySelectorAll('.preview-section-block').forEach(sec => {
            sec.draggable = true;
            sec.addEventListener('dragstart', () => dragged = sec);
            sec.addEventListener('dragend', saveSectionOrder);
        });

        previewContainer.addEventListener('dragover', e => {
            e.preventDefault();
            const after = [...previewContainer.children]
                .find(c => e.clientY < c.getBoundingClientRect().top + c.offsetHeight / 2);
            after ? previewContainer.insertBefore(dragged, after) : previewContainer.appendChild(dragged);
        });
    }

    function saveSectionOrder() {
        const order = [...previewContainer.children].map(s => s.dataset.section);
        localStorage.setItem('resumeSectionOrder', JSON.stringify(order));
    }

    function loadSectionOrder() {
        const order = JSON.parse(localStorage.getItem('resumeSectionOrder') || '[]');
        order.forEach(k => {
            const sec = previewContainer.querySelector(`[data-section="${k}"]`);
            if (sec) previewContainer.appendChild(sec);
        });
    }

});
</script>
